name: Push Request Workflow for Unlocked Package Deployment - Production
on:
  push:
    branches: [ main ]
    paths:
      - 'force-app/main/default/**'

jobs:
  deploy_package:
    name: Unlocked Package Installation
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    container:
        image: salesforce/cli:latest-full

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Production Org-Package Install
        run: |
          echo ${{ secrets.AUTH_PROD }} | sf org login sfdx-url -d -u
          sf package version create -x -p "MyFirstApplication" -w 60 -b main --code-coverage
          echo "Package Version Creation Successfull"
          new_version_id=$(grep -o "04t[[:alnum:]]\{15\}" sfdx-project.json | tail -n1)
          test $(sf package version report -p $new_version_id --json | jq .result.HasPassedCodeCoverageCheck) = 'true'
          echo "Apex Code Coverage Check Successfull"
          echo ${{ secrets.AUTH_PROD }} | sf org login sfdx-url -s -u
          sf package version promote -p $new_version_id -n
          echo "Package Version Promotion Successfull"
          echo ${{ secrets.AUTH_PROD }} | sf org login sfdx-url -s -u
          sf package install -p $new_version_id -w 10 -b 10
          echo "Package Version Installation on Production Successfull"

      - name: Store new Package version Id & tag new Release
        run: |
          tag_name=$(jq ".packageDirectories[0].versionName" sfdx-project.json | tr -d '"'| tr -d ' ')
          pkg_name=$(jq ".packageDirectories[0].package" sfdx-project.json | tr -d '"')
          git config user.name "release[bot]"
          git config user.email "<>"
          git tag -a "$tag_name" -m "$pkg_name $tag_name"
          git add sfdx-project.json
          git commit -m "Updating new pre-release version"
          git push
